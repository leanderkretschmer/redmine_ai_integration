<%= form_tag({ controller: 'settings', action: 'plugin', id: 'redmine_ai_integration' }, method: :post) do %>
  <div class="box tabular">
    <h3>AI-Provider Einstellungen</h3>
    
    <p>
      <%= label_tag 'settings[ai_provider]', 'AI-Provider' %>
      <%= select_tag 'settings[ai_provider]', 
          options_for_select([
            ['OpenAI', 'openai'],
            ['Ollama (selbstgehostet)', 'ollama'],
            ['Google Gemini', 'gemini'],
            ['Anthropic Claude', 'claude']
          ], @settings['ai_provider']),
          id: 'ai_provider_select' %>
    </p>

    <div id="openai_settings" class="provider_settings" style="<%= 'display:none;' unless @settings['ai_provider'] == 'openai' %>">
      <p>
        <%= label_tag 'settings[openai_api_key]', 'OpenAI API Key' %>
        <%= password_field_tag 'settings[openai_api_key]', @settings['openai_api_key'], size: 60 %>
        <em class="info">Ihr OpenAI API-Schlüssel</em>
      </p>
      <p>
        <%= label_tag 'settings[openai_model]', 'OpenAI Modell' %>
        <%= text_field_tag 'settings[openai_model]', @settings['openai_model'] || 'gpt-3.5-turbo', size: 40 %>
        <em class="info">z.B. gpt-3.5-turbo, gpt-4</em>
      </p>
    </div>

    <div id="ollama_settings" class="provider_settings" style="<%= 'display:none;' unless @settings['ai_provider'] == 'ollama' %>">
      <p>
        <%= label_tag 'settings[ollama_url]', 'Ollama URL' %>
        <%= text_field_tag 'settings[ollama_url]', @settings['ollama_url'] || 'http://localhost:11434', size: 60 %>
        <em class="info">URL zu Ihrer Ollama-Instanz (z.B. http://localhost:11434)</em>
      </p>
      <p>
        <%= label_tag 'settings[ollama_model]', 'Ollama Modell' %>
        <%= text_field_tag 'settings[ollama_model]', @settings['ollama_model'] || 'llama2', size: 40 %>
        <em class="info">z.B. llama2, mistral, codellama</em>
      </p>
    </div>

    <div id="gemini_settings" class="provider_settings" style="<%= 'display:none;' unless @settings['ai_provider'] == 'gemini' %>">
      <p>
        <%= label_tag 'settings[gemini_api_key]', 'Gemini API Key' %>
        <%= password_field_tag 'settings[gemini_api_key]', @settings['gemini_api_key'], size: 60 %>
        <em class="info">Ihr Google Gemini API-Schlüssel</em>
      </p>
      <p>
        <%= label_tag 'settings[gemini_model]', 'Gemini Modell' %>
        <%= text_field_tag 'settings[gemini_model]', @settings['gemini_model'] || 'gemini-pro', size: 40 %>
        <em class="info">z.B. gemini-pro, gemini-pro-vision</em>
      </p>
    </div>

    <div id="claude_settings" class="provider_settings" style="<%= 'display:none;' unless @settings['ai_provider'] == 'claude' %>">
      <p>
        <%= label_tag 'settings[claude_api_key]', 'Claude API Key' %>
        <%= password_field_tag 'settings[claude_api_key]', @settings['claude_api_key'], size: 60 %>
        <em class="info">Ihr Anthropic Claude API-Schlüssel</em>
      </p>
      <p>
        <%= label_tag 'settings[claude_model]', 'Claude Modell' %>
        <%= text_field_tag 'settings[claude_model]', @settings['claude_model'] || 'claude-3-sonnet-20240229', size: 40 %>
        <em class="info">z.B. claude-3-opus-20240229, claude-3-sonnet-20240229, claude-3-haiku-20240307</em>
      </p>
    </div>

    <h3>System-Prompt</h3>
    <p>
      <%= label_tag 'settings[system_prompt]', 'System-Prompt für Textverbesserung' %>
      <%= text_area_tag 'settings[system_prompt]', @settings['system_prompt'], rows: 6, cols: 80, style: 'width: 100%;' %>
      <em class="info">Definiert, wie der Text verbessert werden soll. Der Text wird als Variable übergeben.</em>
    </p>

    <h3>Verbindung testen</h3>
    <p>
      <button type="button" id="test_connection_btn" class="button">Verbindung testen</button>
      <span id="test_connection_status" style="margin-left: 10px;"></span>
    </p>
    <div id="test_connection_result" style="margin-top: 10px; display: none;">
      <div id="test_connection_message"></div>
      <div id="test_connection_models" style="margin-top: 10px;"></div>
    </div>
  </div>

  <%= submit_tag l(:button_save) %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const providerSelect = document.getElementById('ai_provider_select');
    const providerSettings = document.querySelectorAll('.provider_settings');
    
    providerSelect.addEventListener('change', function() {
      providerSettings.forEach(function(div) {
        div.style.display = 'none';
      });
      
      const selectedProvider = this.value;
      const selectedDiv = document.getElementById(selectedProvider + '_settings');
      if (selectedDiv) {
        selectedDiv.style.display = 'block';
      }
    });

    // Test Connection Button
    const testBtn = document.getElementById('test_connection_btn');
    const statusSpan = document.getElementById('test_connection_status');
    const resultDiv = document.getElementById('test_connection_result');
    const messageDiv = document.getElementById('test_connection_message');
    const modelsDiv = document.getElementById('test_connection_models');

    testBtn.addEventListener('click', function() {
      const provider = providerSelect.value;
      testBtn.disabled = true;
      statusSpan.textContent = 'Teste Verbindung...';
      statusSpan.style.color = '#666';
      resultDiv.style.display = 'none';

      const formData = new FormData();
      formData.append('provider', provider);

      fetch('/ai_rewrite/test_connection', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
      })
      .then(response => {
        console.log('Test Connection Response Status:', response.status);
        console.log('Test Connection Response Headers:', response.headers);
        
        if (!response.ok) {
          return response.text().then(text => {
            console.error('Test Connection Error Response:', text);
            let errorMsg = 'HTTP ' + response.status + ': ';
            if (response.status === 404) {
              errorMsg += 'Route nicht gefunden. Bitte Redmine neu starten und sicherstellen, dass das Plugin aktiviert ist.';
            } else {
              errorMsg += text.substring(0, 500);
            }
            throw new Error(errorMsg);
          });
        }
        const contentType = response.headers.get('content-type');
        console.log('Test Connection Content-Type:', contentType);
        if (contentType && contentType.includes('application/json')) {
          return response.json();
        } else {
          return response.text().then(text => {
            console.error('Test Connection Invalid Content-Type:', text);
            throw new Error('Ungültige Antwort: Erwartet JSON, erhalten: ' + text.substring(0, 200));
          });
        }
      })
      .then(data => {
        console.log('Test Connection Success Data:', data);
        testBtn.disabled = false;
        resultDiv.style.display = 'block';

        if (data.success) {
          statusSpan.textContent = 'Erfolgreich';
          statusSpan.style.color = 'green';
          messageDiv.innerHTML = '<strong style="color: green;">' + (data.message || 'Verbindung erfolgreich') + '</strong>';
          
          if (data.models && data.models.length > 0) {
            modelsDiv.innerHTML = '<strong>Verfügbare Modelle:</strong><ul style="margin-top: 5px; margin-left: 20px;">' +
              data.models.map(function(model) {
                return '<li>' + model + '</li>';
              }).join('') + '</ul>';
          } else {
            modelsDiv.innerHTML = '';
          }
        } else {
          statusSpan.textContent = 'Fehler';
          statusSpan.style.color = 'red';
          let errorHtml = '<strong style="color: red;">Fehler:</strong> ' + (data.error || 'Unbekannter Fehler');
          if (data.backtrace) {
            errorHtml += '<br><small style="color: #666;">Stack Trace: ' + data.backtrace.join('<br>') + '</small>';
          }
          messageDiv.innerHTML = errorHtml;
          modelsDiv.innerHTML = '';
        }
      })
      .catch(error => {
        console.error('Test Connection Exception:', error);
        testBtn.disabled = false;
        statusSpan.textContent = 'Fehler';
        statusSpan.style.color = 'red';
        resultDiv.style.display = 'block';
        messageDiv.innerHTML = '<strong style="color: red;">Fehler:</strong> ' + error.message + '<br><small style="color: #666;">Bitte prüfen Sie die Browser-Konsole (F12) für weitere Details.</small>';
        modelsDiv.innerHTML = '';
      });
    });
  });
</script>

